---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import { Card, Lazy, Pagination, Responsive, Section } from '@components/common';
import { StoryCategories, StoryCategoryExpansionButton, StoryCategory, StoryPageHeader } from '@components/story';
import { Layout } from '@components/layout';
import { CATEGORY } from '@constants/post';
import { getCategoryNameFromSlug, getStoryLinkFromSlug } from '@utils/post';
import { PageSEO } from '@components/helper';

export const getStaticPaths = (async ({ paginate }) => {
  const storyCollection = await getCollection('story');

  return Object.entries(CATEGORY).flatMap(([key]) => {
    // ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§ í›„, ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
    const stories = (
      (key as keyof typeof CATEGORY) === 'all'
        ? storyCollection
        : storyCollection.filter((story) => story.slug.split('/')[0] === key)
    ).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

    // ì¹´í…Œê³ ë¦¬ë³„ í˜ì´ì§€ë„¤ì´ì…˜
    return paginate(stories, {
      pageSize: 9,
      params: { category: key },
      props: {
        categories: Object.entries(CATEGORY).map(([key, value]) => ({
          name: value,
          count:
            (key as keyof typeof CATEGORY) === 'all'
              ? storyCollection.length
              : storyCollection.filter((story) => story.slug.split('/')[0] === key).length,
          href: `/story/${key}/page/1`,
        })),
      },
    });
  });
}) satisfies GetStaticPaths;

const { page, categories } = Astro.props;
const { pathname } = Astro.url;
---

<Layout pageTitle="í™”ë ¤íˆ ë°˜ì§ì¼ ë‚˜ì˜ ìŠ¤í† ë¦¬ (ï½¡â€¢Ì€á´—-)âœ§" headerBg>
  <Section>
    <Responsive>
      <StoryPageHeader />
      <StoryCategories>
        {categories.map((category) => <StoryCategory slot="item" pathname={pathname} {...category} client:load />)}
        <StoryCategoryExpansionButton slot="button" categories={categories} pathname={pathname} client:load />
      </StoryCategories>
      <Lazy className="mt-8 grid gap-8 lg:mt-16 lg:grid-cols-3">
        {
          page.data.map(({ slug, data }) => (
            <a href={getStoryLinkFromSlug(slug)}>
              <Card
                thumbnail={data.thumbnail}
                title={data.title}
                description={data.description}
                date={data.date}
                category={getCategoryNameFromSlug(slug)}
              />
            </a>
          ))
        }
      </Lazy>
      <Pagination
        className="mt-12 lg:mt-20"
        page={page.currentPage}
        lastPage={page.lastPage}
        buttonUrlPrefix={page.url.current.replace(/\/\d+$/, '')}
        prevUrl={page.url.prev}
        nextUrl={page.url.next}
        client:load
      />
    </Responsive>
  </Section>

  <!-- HEAD -->
  <PageSEO
    slot="meta-data"
    title="í™”ë ¤íˆ ë°˜ì§ì¼ ë‚˜ì˜ ìŠ¤í† ë¦¬ (ï½¡â€¢Ì€á´—-)âœ§"
    description="í•™ìŠµí•˜ê³ , ê²½í—˜í•œ ê²ƒ ì™¸ì— ì¼ìƒ ì†ì˜ ì‘ì€ ì´ë²¤íŠ¸ë„ ê¸°ë¡í•©ë‹ˆë‹¤ ğŸ“"
    keywords={['ìŠ¤í† ë¦¬', 'Story']}
  />
</Layout>

<script>
  // í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
  document.querySelector('.current-category')?.scrollIntoView({ block: 'center' });
</script>
