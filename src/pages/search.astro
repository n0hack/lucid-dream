---
import { getCollection } from 'astro:content';
import purify from 'isomorphic-dompurify';
import Fuse from 'fuse.js';
import { twMerge } from 'tailwind-merge';
import { Lazy, Responsive, Section } from '@components/common';
import { SearchResult, SearchResultEmpty, SearchResultHeader } from '@components/search';
import { Layout } from '@components/layout';
import { getCategoryNameFromSlug, getStoryLinkFromSlug } from '@utils/post';
import { PageSEO } from '@components/helper';
import { SITE_URL } from '@constants/seo';

const query = Astro.url.searchParams.get('q') ?? '';

// í•œê¸€ ê²€ìƒ‰ì–´ë¥¼ ìœ„í•œ ë””ì½”ë”©ê³¼ DOMPurifyë¥¼ ì´ìš©í•œ XSS ë°©ì–´
const decodedQuery = decodeURIComponent(query);
const sanitizedQuery = purify.sanitize(decodedQuery);

const storyCollection = await getCollection('story');

// Fuse.js ê²€ìƒ‰ì„ ìœ„í•´ ë°ì´í„° ê°€ê³µ
const mappedList = storyCollection.map((story) => ({
  ...story.data,
  href: getStoryLinkFromSlug(story.slug),
  body: story.body,
  category: {
    key: story.slug.split('/')[0],
    value: getCategoryNameFromSlug(story.slug),
  },
}));

// TODO ê°€ì¤‘ì¹˜ë¥¼ ë”ìš± ì„¸ë°€í•˜ê²Œ ì¡°ì •í•´ì•¼ í•¨
const fuse = new Fuse(mappedList, {
  keys: [
    { name: 'title', weight: 1 },
    { name: 'body', weight: 1 },
    { name: 'tags', weight: 1 },
    { name: 'category.key', weight: 1 },
    { name: 'category.value', weight: 1 },
  ],
});

const result = fuse.search(sanitizedQuery);

const pageTitle = sanitizedQuery === '' ? 'ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš” ğŸ’¦' : `'${sanitizedQuery}' ê²€ìƒ‰ ê²°ê³¼ (ï½¡â€¢Ì€á´—-)âœ§`;

export const prerender = false;
---

<Layout pageTitle={pageTitle} headerBg>
  <Section className={twMerge(result.length === 0 && 'flex flex-1 flex-col')}>
    <Responsive className={twMerge(result.length === 0 && 'flex flex-1 flex-col')}>
      <SearchResultHeader query={sanitizedQuery} />
      {
        result.length === 0 ? (
          <SearchResultEmpty />
        ) : (
          <Lazy className="mt-12 lg:mt-20">
            <SearchResult datas={result} client:load />
          </Lazy>
        )
      }
    </Responsive>
  </Section>

  <!-- HEAD -->
  <PageSEO
    slot="meta-data"
    title="ê²€ìƒ‰ ê²°ê³¼ (ï½¡â€¢Ì€á´—-)âœ§"
    description="ê²€ìƒ‰ì„ í†µí•´ ì•Œë§ì€ ìŠ¤í† ë¦¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš” âœ¨"
    keywords={['ê²€ìƒ‰', 'Search']}
  />
  <link rel="canonical" href={`${SITE_URL}/search`} />
  <link rel="canonical" href="/search" />
</Layout>
